@using Microsoft.AspNetCore.Identity
@using CampusActivityHub.Models
@using CampusActivityHub.Extensions 
@model IEnumerable<Event>
@inject UserManager<User> UserManager

@{
    ViewData["Title"] = ViewBag.FilterName != null ? $"–ü–æ–¥—ñ—ó: {ViewBag.FilterName}" : "–í—Å—ñ –ø–æ–¥—ñ—ó";
    var currentUser = await UserManager.GetUserAsync(User);
}

<style>
    /* -- –°–¢–ò–õ–Ü –î–õ–Ø –¢–ï–ú–ù–ò–• –ö–ê–†–¢–û–ö -- */
    
    .event-card { 
        background-color: #212529; /* –¢–µ–º–Ω–æ-—Å—ñ—Ä–∏–π —Ñ–æ–Ω –∫–∞—Ä—Ç–∫–∏ –∑–∞–º—ñ—Å—Ç—å –±—ñ–ª–æ–≥–æ */
        border: 1px solid #343a40; /* –¢–µ–º–Ω–∞ —Ä–∞–º–∫–∞ */
        border-radius: 12px; 
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .event-card:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 10px 20px rgba(0,0,0,0.5); 
        border-color: #6f42c1; /* –§—ñ–æ–ª–µ—Ç–æ–≤–∞ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
    }

    /* –í–µ—Ä—Ö–Ω—è –∫–æ–ª—å–æ—Ä–æ–≤–∞ —Å–º—É–∂–∫–∞ (–∑–∞–º—ñ—Å—Ç—å —Ñ–æ—Ç–æ) */
    .card-decoration {
        height: 6px;
        width: 100%;
        background: linear-gradient(90deg, #0d6efd, #6610f2); /* –°–∏–Ω—ñ–π -> –§—ñ–æ–ª–µ—Ç–æ–≤–∏–π */
    }

    /* –¢–µ–∫—Å—Ç–∏ */
    .card-title { 
        color: #f8f9fa; /* –ú–∞–π–∂–µ –±—ñ–ª–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        font-weight: 700;
        margin-top: 15px;
    }
    
    .card-text { 
        color: #adb5bd; /* –°–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π –æ–ø–∏—Å */
    }
    
    .text-muted-custom {
        color: #6c757d !important;
        font-size: 0.9em;
    }

    /* –ë–µ–π–¥–∂ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó */
    .category-badge {
        background-color: rgba(13, 110, 253, 0.15);
        color: #6ea8fe;
        padding: 5px 10px;
        border-radius: 8px;
        font-size: 0.85rem;
        text-decoration: none;
        border: 1px solid rgba(13, 110, 253, 0.3);
    }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn-join {
        background: linear-gradient(45deg, #0d6efd, #6610f2);
        border: none;
        color: white;
        font-weight: 500;
    }
    .btn-join:hover {
        opacity: 0.9;
        color: white;
        box-shadow: 0 0 10px rgba(102, 16, 242, 0.5);
    }
    .btn-join:disabled {
        background: #495057;
        color: #adb5bd;
    }
    
    .btn-already-joined {
        background-color: rgba(25, 135, 84, 0.2);
        color: #20c997;
        border: 1px solid #198754;
        cursor: default;
    }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="display-5 fw-bold text-white">@(ViewBag.FilterName ?? "–í—Å—ñ –ø–æ–¥—ñ—ó")</h1>
            <p class="text-white-50">–ó–Ω–∞–π–¥–∏ –ø–æ–¥—ñ—é –¥–æ –¥—É—à—ñ —Ç–∞ –ø—Ä–∏—î–¥–Ω—É–π—Å—è! üöÄ</p>
        </div>
    </div>

    @if (User.IsInRole("Admin"))
    {
        <div class="mb-4">
             <a asp-controller="Admin" asp-action="Dashboard" class="btn btn-outline-light rounded-pill px-4">
                 <i class="bi bi-speedometer2 me-2"></i> –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å
             </a>
        </div>
    }

    <div class="row g-4">
        @foreach (var item in Model)
        {
            int registeredCount = item.Registrations?.Count ?? 0;
            int placesLeft = item.MaxParticipants - registeredCount;
            bool isRegistered = currentUser != null && item.Registrations.Any(r => r.UserId == currentUser.Id);

            <div class="col-md-4">
                <div class="event-card">
                    <div class="card-decoration"></div>
                    
                    <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="category-badge">@item.Category?.Name</span>
                            @Html.EventStatus(item)
                        </div>

                        <h4 class="card-title">@item.Title</h4>
                        
                        <div class="mb-3 text-muted-custom">
                            <i class="bi bi-calendar-event me-2"></i>@item.Date.ToString("d MMMM HH:mm")
                        </div>
                        
                        <p class="card-text flex-grow-1">@item.Description</p>
                        
                        <hr style="border-color: #495057;">

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-white-50">
                                <i class="bi bi-people-fill me-1"></i>
                                –í—ñ–ª—å–Ω–æ: <strong class="text-white" id="places-@item.Id">@placesLeft</strong> / @item.MaxParticipants
                            </small>

                            @if (User.Identity.IsAuthenticated)
                            {
                                if (isRegistered)
                                {
                                    <button class="btn btn-already-joined rounded-pill px-3 btn-sm" disabled>
                                        <i class="bi bi-check-circle-fill me-1"></i> –í–∏ –π–¥–µ—Ç–µ
                                    </button>
                                }
                                else
                                {
                                    <button onclick="joinEvent(@item.Id)" id="btn-@item.Id" 
                                            class="btn btn-join rounded-pill px-4 btn-sm" 
                                            @(placesLeft <= 0 ? "disabled" : "")>
                                        –í–∑—è—Ç–∏ —É—á–∞—Å—Ç—å
                                    </button>
                                }
                            }
                            else
                            {
                                <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-outline-secondary rounded-pill btn-sm">–£–≤—ñ–π—Ç–∏</a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
    // –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í–∑—è—Ç–∏ —É—á–∞—Å—Ç—å" –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    async function joinEvent(eventId) {
        const button = document.getElementById(`btn-${eventId}`);
        const placesSpan = document.getElementById(`places-${eventId}`);

        // –ë–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É —ñ –ø–æ–∫–∞–∑—É—î–º–æ —Å–ø—ñ–Ω–µ—Ä
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        button.disabled = true;

        try {
            const response = await fetch(`/Events/JoinAjax?eventId=${eventId}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            });

            const data = await response.json();

            if (data.success) {
                // –ó–º—ñ–Ω—é—î–º–æ –≤–∏–≥–ª—è–¥ –∫–Ω–æ–ø–∫–∏ –Ω–∞ "–í–∏ –π–¥–µ—Ç–µ"
                button.className = "btn btn-already-joined rounded-pill px-3 btn-sm";
                button.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> –í–∏ –π–¥–µ—Ç–µ';
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –º—ñ—Å—Ü—å
                placesSpan.innerText = data.placesLeft;
            } else {
                alert(data.message);
                button.innerHTML = '–í–∑—è—Ç–∏ —É—á–∞—Å—Ç—å';
                button.disabled = false;
            }
        } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞:', error);
            button.innerHTML = '–í–∑—è—Ç–∏ —É—á–∞—Å—Ç—å';
            button.disabled = false;
        }
    }
</script>
}
@Html.AntiForgeryToken()